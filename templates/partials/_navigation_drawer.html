{# MD3 Navigation Drawer - Modal (Compact/Medium) & Standard (Expanded) #}
{% set user_name = g.user %}
{% set user_role = g.role %}
{% set is_authenticated = user_name is not none %}
{% set role_value = user_role.value if user_role else '' %}
{% set active_endpoint = request.endpoint %}

{# Define navigation items with icons #}
{% set main_nav_items = [
  {
    'label': 'Startseite',
    'href': url_for('public.landing_page'),
    'icon': 'home',
    'match': ['public.landing_page']
  },
  {
    'label': 'Projekt',
    'icon': 'folder_open',
    'submenu': [
      {
        'label': 'Über das Projekt',
        'href': url_for('public.projekt_ueber'),
        'match': ['public.projekt_ueber']
      },
      {
        'label': 'Didaktisches Konzept',
        'href': url_for('public.projekt_konzept'),
        'match': ['public.projekt_konzept']
      },
      {
        'label': 'Offene Entwicklung',
        'href': url_for('public.projekt_entwicklung'),
        'match': ['public.projekt_entwicklung']
      }
    ]
  },
  {
    'label': 'Quiz',
    'href': url_for('quiz.quiz_index'),
    'icon': 'quiz',
    'match': ['quiz.quiz_index', 'quiz.quiz_topic_entry', 'quiz.quiz_play']
  }
] %}

{# Modal Navigation Drawer (Compact/Medium) - Dialog-basiert #}
<dialog id="navigation-drawer-modal" 
        class="drawer" 
        aria-label="Hauptnavigation">
  <div class="drawer__panel">
    {# Header with Brand #}
    <div class="md3-navigation-drawer__header">
      <a href="{{ url_for('public.landing_page') }}" 
         class="md3-navigation-drawer__logo-link"
         tabindex="-1"
         aria-label="Zur Startseite">
        <img src="{{ url_for('static', filename='img/hispanistica_games_logo.png') }}" 
             alt="games.hispanistica" 
             class="md3-navigation-drawer__logo">
      </a>
    </div>

    {# Main Navigation Items #}
    <nav class="md3-navigation-drawer__content" aria-label="Hauptmenü">
      {% for item in main_nav_items %}
        {% if item.submenu %}
          {# Accordion-Item mit Submenu #}
          {% set has_active_child = namespace(found=false) %}
          {% for subitem in item.submenu %}
            {% if active_endpoint in subitem.match %}
              {% set has_active_child.found = true %}
            {% endif %}
          {% endfor %}
          
          <div class="md3-navigation-drawer__collapsible">
            <button type="button"
                    id="drawer-trigger-{{ loop.index }}"
                    class="md3-navigation-drawer__item md3-navigation-drawer__trigger {{ 'md3-navigation-drawer__item--active' if has_active_child.found else '' }}"
                    aria-expanded="{{ 'true' if has_active_child.found else 'false' }}"
                    aria-controls="drawer-submenu-{{ loop.index }}"
                    data-section="{{ item.label|lower }}">
              <span class="material-symbols-rounded md3-navigation-drawer__icon">{{ item.icon }}</span>
              <span class="md3-navigation-drawer__label">{{ item.label }}</span>
              <span class="material-symbols-rounded md3-navigation-drawer__chevron">expand_more</span>
            </button>
            
            <div id="drawer-submenu-{{ loop.index }}"
                 class="md3-navigation-drawer__submenu"
                 role="group"
                 aria-labelledby="drawer-trigger-{{ loop.index }}"
                 aria-hidden="{{ 'false' if has_active_child.found else 'true' }}"
                 {{ 'data-open' if has_active_child.found else '' }}>
              <div class="md3-navigation-drawer__submenu-inner">
                {% for subitem in item.submenu %}
                  {% set is_active_sub = active_endpoint in subitem.match %}
                  <a href="{{ subitem.href }}"
                     class="md3-navigation-drawer__subitem {{ 'md3-navigation-drawer__subitem--active' if is_active_sub else '' }}"
                     aria-current="{{ 'page' if is_active_sub else 'false' }}">
                    <span class="md3-navigation-drawer__label">{{ subitem.label }}</span>
                  </a>
                {% endfor %}
              </div>
            </div>
          </div>
        {% else %}
          {# Simple navigation item #}
          {% set is_active = active_endpoint in item.match %}
          <a href="{{ item.href }}" 
             class="md3-navigation-drawer__item {{ 'md3-navigation-drawer__item--active' if is_active else '' }}"
             aria-current="{{ 'page' if is_active else 'false' }}">
            <span class="material-symbols-rounded md3-navigation-drawer__icon">{{ item.icon }}</span>
            <span class="md3-navigation-drawer__label">{{ item.label }}</span>
          </a>
        {% endif %}
      {% endfor %}
    </nav>

    {# Footer Navigation - Role-based Account Section #}
    <nav class="md3-navigation-drawer__footer" aria-label="Account">
      {% if is_authenticated %}
        {# Divider before account section #}
        <hr class="md3-divider" role="separator" aria-hidden="true">
        
        {# Profile - visible to all authenticated users #}
        <a href="{{ url_for('auth.account_profile_page') }}"
           class="md3-navigation-drawer__item {{ 'md3-navigation-drawer__item--active' if active_endpoint == 'auth.account_profile_page' else '' }}"
           aria-current="{{ 'page' if active_endpoint == 'auth.account_profile_page' else 'false' }}">
          <span class="material-symbols-rounded md3-navigation-drawer__icon">person</span>
          <span class="md3-navigation-drawer__label">Profil</span>
        </a>
        
        {# Admin-only: User Management #}
        {% if role_value == 'admin' %}
          <a href="{{ url_for('auth.admin_users_page') }}"
             class="md3-navigation-drawer__item {{ 'md3-navigation-drawer__item--active' if active_endpoint == 'auth.admin_users_page' else '' }}"
             aria-current="{{ 'page' if active_endpoint == 'auth.admin_users_page' else 'false' }}">
            <span class="material-symbols-rounded md3-navigation-drawer__icon">group</span>
            <span class="md3-navigation-drawer__label">Benutzer</span>
          </a>
        {% endif %}
        
        {# Logout - always at the bottom for authenticated users #}
        <a href="{{ url_for('auth.logout_any') }}"
           data-logout="fetch"
           data-logout-url="{{ url_for('auth.logout_any') }}"
           data-logout-method="POST"
           class="md3-navigation-drawer__item md3-navigation-drawer__item--logout">
          <span class="material-symbols-rounded md3-navigation-drawer__icon">logout</span>
          <span class="md3-navigation-drawer__label">Logout</span>
        </a>
      {% else %}
        {# Unauthenticated: Login #}
        {# Divider before login section #}
        <hr class="md3-divider" role="separator" aria-hidden="true">
        
        <a href="{{ url_for('public.login', next=request.path) }}"
           class="md3-navigation-drawer__item">
          <span class="material-symbols-rounded md3-navigation-drawer__icon">account_circle</span>
          <span class="md3-navigation-drawer__label">Login</span>
        </a>
      {% endif %}
    </nav>
  </div>
</dialog>

{# Standard Navigation Drawer (Expanded) - für Desktop #}
<aside class="md3-navigation-drawer md3-navigation-drawer--standard" 
       id="navigation-drawer-standard"
       aria-label="Hauptnavigation">
  {# Header with Brand #}
  <div class="md3-navigation-drawer__header">
    <a href="{{ url_for('public.landing_page') }}" 
       class="md3-navigation-drawer__logo-link"
       tabindex="-1"
       aria-label="Zur Startseite">
      <img src="{{ url_for('static', filename='img/hispanistica_games_logo.png') }}" 
           alt="games.hispanistica" 
           class="md3-navigation-drawer__logo">
    </a>
  </div>

  {# Main Navigation Items #}
  <nav class="md3-navigation-drawer__content" aria-label="Hauptmenü">
    {% for item in main_nav_items %}
      {% if item.submenu %}
        {# Accordion-Item mit Submenu #}
        {% set has_active_child = namespace(found=false) %}
        {% for subitem in item.submenu %}
          {% if active_endpoint in subitem.match %}
            {% set has_active_child.found = true %}
          {% endif %}
        {% endfor %}
        
        <div class="md3-navigation-drawer__collapsible">
          <button type="button"
                  id="drawer-standard-trigger-{{ loop.index }}"
                  class="md3-navigation-drawer__item md3-navigation-drawer__trigger {{ 'md3-navigation-drawer__item--active' if has_active_child.found else '' }}"
                  aria-expanded="{{ 'true' if has_active_child.found else 'false' }}"
                  aria-controls="drawer-standard-submenu-{{ loop.index }}"
                  data-section="{{ item.label|lower }}">
            <span class="material-symbols-rounded md3-navigation-drawer__icon">{{ item.icon }}</span>
            <span class="md3-navigation-drawer__label">{{ item.label }}</span>
            <span class="material-symbols-rounded md3-navigation-drawer__chevron">expand_more</span>
          </button>
          
          <div id="drawer-standard-submenu-{{ loop.index }}"
               class="md3-navigation-drawer__submenu"
               role="group"
               aria-labelledby="drawer-standard-trigger-{{ loop.index }}"
               aria-hidden="{{ 'false' if has_active_child.found else 'true' }}"
               {{ 'data-open' if has_active_child.found else '' }}>
            <div class="md3-navigation-drawer__submenu-inner">
              {% for subitem in item.submenu %}
                {% set is_active_sub = active_endpoint in subitem.match %}
                <a href="{{ subitem.href }}"
                   class="md3-navigation-drawer__subitem {{ 'md3-navigation-drawer__subitem--active' if is_active_sub else '' }}"
                   aria-current="{{ 'page' if is_active_sub else 'false' }}">
                  <span class="md3-navigation-drawer__label">{{ subitem.label }}</span>
                </a>
              {% endfor %}
            </div>
          </div>
        </div>
      {% else %}
        {# Simple navigation item #}
        {% set is_active = active_endpoint in item.match %}
        <a href="{{ item.href }}" 
           class="md3-navigation-drawer__item {{ 'md3-navigation-drawer__item--active' if is_active else '' }}"
           aria-current="{{ 'page' if is_active else 'false' }}">
          <span class="material-symbols-rounded md3-navigation-drawer__icon">{{ item.icon }}</span>
          <span class="md3-navigation-drawer__label">{{ item.label }}</span>
        </a>
      {% endif %}
    {% endfor %}
  </nav>

  {# Footer Navigation - Role-based Account Section #}
  <nav class="md3-navigation-drawer__footer" aria-label="Account">
    {% if is_authenticated %}
      {# Divider before account section #}
      <hr class="md3-divider" role="separator" aria-hidden="true">
      
      {# Profile - visible to all authenticated users #}
      <a href="{{ url_for('auth.account_profile_page') }}"
         class="md3-navigation-drawer__item {{ 'md3-navigation-drawer__item--active' if active_endpoint == 'auth.account_profile_page' else '' }}"
         aria-current="{{ 'page' if active_endpoint == 'auth.account_profile_page' else 'false' }}">
        <span class="material-symbols-rounded md3-navigation-drawer__icon">person</span>
        <span class="md3-navigation-drawer__label">Profil</span>
      </a>
      
      {# Admin-only: User Management #}
      {% if role_value == 'admin' %}
        <a href="{{ url_for('auth.admin_users_page') }}"
           class="md3-navigation-drawer__item {{ 'md3-navigation-drawer__item--active' if active_endpoint == 'auth.admin_users_page' else '' }}"
           aria-current="{{ 'page' if active_endpoint == 'auth.admin_users_page' else 'false' }}">
          <span class="material-symbols-rounded md3-navigation-drawer__icon">group</span>
          <span class="md3-navigation-drawer__label">Benutzer</span>
        </a>
      {% endif %}
      
      {# Logout - always at the bottom for authenticated users #}
      <a href="{{ url_for('auth.logout_any') }}"
         data-logout="fetch"
         data-logout-url="{{ url_for('auth.logout_any') }}"
         data-logout-method="POST"
         class="md3-navigation-drawer__item md3-navigation-drawer__item--logout">
        <span class="material-symbols-rounded md3-navigation-drawer__icon">logout</span>
        <span class="md3-navigation-drawer__label">Logout</span>
      </a>
    {% else %}
      {# Unauthenticated: Login #}
      {# Divider before login section #}
      <hr class="md3-divider" role="separator" aria-hidden="true">
      
      <a href="{{ url_for('public.login', next=request.path) }}"
         class="md3-navigation-drawer__item">
        <span class="material-symbols-rounded md3-navigation-drawer__icon">account_circle</span>
        <span class="md3-navigation-drawer__label">Login</span>
      </a>
    {% endif %}
  </nav>
</aside>

