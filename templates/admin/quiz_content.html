{% extends "base.html" %}

{% set page_section = 'Admin' %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/auth.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/search-ui.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/quiz_content.css') }}">
{% endblock %}

{% block content %}
<div class="md3-page">
  <!-- Canonical Hero -->
  <header class="md3-page__header">
    <div class="md3-hero md3-hero--card md3-hero__container">
      <div class="md3-hero__icon" aria-hidden="true"><span class="material-symbols-rounded">quiz</span></div>
      <div class="md3-hero__content">
        <p class="md3-body-small md3-hero__eyebrow">Admin</p>
        <h1 class="md3-headline-medium md3-hero__title">Dashboard</h1>
        <p class="md3-hero__intro">Verwalte Quiz-Units, Release-Importe und Veröffentlichungen.</p>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="md3-tabs" role="tablist">
    <button role="tab" aria-selected="true" aria-controls="tab-content" id="tab-quiz" class="md3-tab md3-tab--active">
      <span class="material-symbols-rounded">quiz</span>
      Quiz-Inhalte
    </button>
    <button role="tab" aria-selected="false" class="md3-tab" disabled aria-disabled="true">
      <span class="material-symbols-rounded">bar_chart</span>
      Statistiken
      <span class="md3-badge md3-badge--small md3-badge--info">Demnächst</span>
    </button>
  </nav>

  <main class="md3-page__main" id="tab-content" role="tabpanel" aria-labelledby="tab-quiz">
    <div class="md3-page__section md3-stack--page">

      <!-- ═══════════════ CONTENT PIPELINE ═══════════════ -->
      <div class="md3-section-header">
        <span class="material-symbols-rounded md3-section-header__icon">cloud_upload</span>
        <span class="md3-title-small">Content-Pipeline</span>
      </div>

      <!-- Section 1: Upload Unit -->
      <section class="md3-card md3-card--outlined md3-section-card" id="upload-section">
        <header class="md3-card__header md3-section-card__header">
          <div class="md3-section-card__title">
            <span class="material-symbols-rounded" aria-hidden="true">upload_file</span>
            <div>
              <h2 class="md3-title-medium">Unit hochladen</h2>
              <p class="md3-body-small md3-section-card__subtitle">JSON + optionale Audiodateien</p>
            </div>
          </div>
        </header>
        <div class="md3-card__content md3-stack--section md3-section-card__body">
          <form id="upload-form" class="md3-form" enctype="multipart/form-data">
            <div class="md3-form-grid">
              <!-- JSON File Input -->
              <div class="form-field form-field--file">
                <label for="unit-json">JSON-Datei (erforderlich)</label>
                <input type="file" id="unit-json" name="unit_json" accept=".json" required aria-describedby="json-help">
                <p id="json-help" class="md3-helper-text">Eine Quiz-Unit JSON-Datei mit slug, title, questions.</p>
              </div>

              <!-- Media Files Input -->
              <div class="form-field form-field--file">
                <label for="media-files">Audio-Dateien (optional)</label>
                <input type="file" id="media-files" name="media_files[]" accept=".mp3,.ogg,.wav" multiple aria-describedby="media-help">
                <p id="media-help" class="md3-helper-text">MP3, OGG oder WAV Dateien für Fragen.</p>
              </div>

              <!-- Optional Release Target -->
              <div class="form-field form-field--select">
                <label for="upload-release-select">Release (optional)</label>
                <select id="upload-release-select" name="release_id" aria-describedby="release-help">
                  <option value="">Neu (Release-ID automatisch)</option>
                </select>
                <p id="release-help" class="md3-helper-text">Optional: in bestehendes Release hochladen (kein Löschen anderer Units).</p>
              </div>
            </div>

            <!-- JSON Preview (appears after file selection) -->
            <div id="json-preview" class="md3-info-card" hidden>
              <h3 class="md3-title-small">Vorschau</h3>
              <dl class="md3-preview-grid">
                <dt>Slug:</dt>
                <dd id="preview-slug">-</dd>
                <dt>Titel:</dt>
                <dd id="preview-title">-</dd>
                <dt>Fragen:</dt>
                <dd id="preview-questions">-</dd>
              </dl>
              <div id="media-refs" class="md3-media-refs" hidden>
                <h4 class="md3-label-medium">Audio-Referenzen:</h4>
                <ul id="media-refs-list" class="md3-media-ref-list"></ul>
              </div>
            </div>

            <!-- Validation Errors -->
            <div id="upload-errors" class="md3-alert md3-alert--error md3-alert--inline" role="alert" hidden>
              <span class="material-symbols-rounded md3-alert__icon" aria-hidden="true">error</span>
              <div class="md3-alert__content">
                <p id="upload-error-title" class="md3-alert__title">Validierungsfehler</p>
                <p id="upload-error-message" class="md3-alert__text"></p>
              </div>
            </div>

            <!-- Upload Actions -->
            <div class="md3-toolbar md3-toolbar--end">
              <button type="button" id="reset-upload" class="md3-button md3-button--text" disabled>
                Zurücksetzen
              </button>
              <button type="submit" id="submit-upload" class="md3-button md3-button--filled" disabled>
                <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">cloud_upload</span>
                Upload speichern
              </button>
            </div>
            <p id="upload-actions-helper" class="md3-helper-text" role="status" aria-live="polite">
              JSON-Datei auswählen, um Upload zu starten.
            </p>
          </form>
        </div>
      </section>

      <!-- Section 2: Release Actions -->
      <section class="md3-card md3-card--outlined md3-section-card" id="releases-section">
        <header class="md3-card__header md3-section-card__header">
          <div class="md3-section-card__title">
            <span class="material-symbols-rounded" aria-hidden="true">inventory_2</span>
            <div>
              <h2 class="md3-title-medium">Release</h2>
              <p class="md3-body-small md3-section-card__subtitle">Importieren, veröffentlichen, zurücknehmen</p>
            </div>
          </div>
        </header>
        <div class="md3-card__content md3-stack--section md3-section-card__body">
          <!-- Release Selection -->
          <div class="md3-section-toolbar">
            <div class="md3-section-toolbar__start">
              <div class="form-field form-field--select">
                <label for="release-select">Release auswählen</label>
                <select id="release-select" aria-label="Release auswählen" aria-describedby="release-select-helper">
                  <option value="">-- Laden... --</option>
                </select>
                <p id="release-select-helper" class="md3-helper-text">Wählen Sie ein Release für Import/Veröffentlichung.</p>
              </div>
            </div>
            <div class="md3-section-toolbar__end">
              <button id="refresh-releases" class="md3-button md3-button--outlined" type="button">
                <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">refresh</span>
                Aktualisieren
              </button>
            </div>
          </div>

          <!-- Release Info -->
          <div id="release-info" class="md3-release-status" hidden>
            <div class="md3-release-status__header">
              <span id="release-id-display" class="md3-label-large">-</span>
              <span id="release-status-badge" class="md3-badge md3-badge--status-draft">Draft</span>
            </div>
            <div class="md3-release-status__meta">
              <span><strong>Units:</strong> <span id="release-units-count">0</span></span>
              <span><strong>Fragen:</strong> <span id="release-questions-count">0</span></span>
              <span><strong>Audio:</strong> <span id="release-audio-count">0</span></span>
            </div>
            <div class="md3-release-status__timestamps">
              <span id="release-imported-at"></span>
              <span id="release-published-at"></span>
            </div>
          </div>

          <!-- Action Result -->
          <div id="release-action-result" class="md3-action-result" role="status" aria-live="polite" hidden></div>

          <!-- Release Actions -->
          <div class="md3-section-actions">
            <button id="btn-import" class="md3-button md3-button--tonal" type="button" disabled>
              <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">download</span>
              Import (Draft)
            </button>
            <button id="btn-publish" class="md3-button md3-button--filled" type="button" disabled>
              <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">publish</span>
              Veröffentlichen
            </button>
            <button id="btn-unpublish" class="md3-button md3-button--outlined" type="button" disabled>
              <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">unpublished</span>
              Veröffentlichung zurücknehmen
            </button>
          </div>
          <div class="md3-alert md3-alert--warning md3-alert--inline md3-release-warning" role="note">
            <span class="material-symbols-rounded md3-alert__icon" aria-hidden="true">warning</span>
            <div class="md3-alert__content">
              <p class="md3-alert__title">Hinweis</p>
              <p class="md3-alert__text">Das Veröffentlichen ersetzt den aktuell veröffentlichten Content.</p>
            </div>
          </div>
          <p id="release-actions-helper" class="md3-helper-text" role="status" aria-live="polite">
            Release auswählen, um Aktionen zu aktivieren.
          </p>

          <!-- Log Viewer -->
          <details id="log-viewer" class="md3-log-viewer">
            <summary class="md3-log-viewer__summary">
              <span class="material-symbols-rounded">terminal</span>
              Import-Log anzeigen
            </summary>
            <pre id="log-content" class="md3-log-viewer__content">Kein Log vorhanden.</pre>
          </details>
        </div>
      </section>

      <!-- ═══════════════ RUNTIME CONFIGURATION ═══════════════ -->
      <div class="md3-section-header">
        <span class="material-symbols-rounded md3-section-header__icon">tune</span>
        <span class="md3-title-small">Units-Verwaltung</span>
      </div>

      <!-- Section 3: Units List -->
      <section class="md3-card md3-card--outlined md3-section-card" id="units-section">
        <header class="md3-card__header md3-section-card__header">
          <div class="md3-section-card__title">
            <span class="material-symbols-rounded" aria-hidden="true">list_alt</span>
            <div>
              <h2 class="md3-title-medium">Units</h2>
              <p class="md3-body-small md3-section-card__subtitle">Suche, Filter und Reihenfolge</p>
            </div>
          </div>
        </header>
        <div class="md3-card__content md3-stack--section md3-section-card__body">
          <!-- Search and Toolbar -->
          <div class="md3-section-toolbar md3-section-toolbar--wrap">
            <div class="md3-section-toolbar__start">
              <div class="form-field form-field--compact form-field--no-margin md3-search-field">
                <label for="units-search" class="sr-only">Units suchen</label>
                <input id="units-search" type="search" aria-describedby="units-search-helper" placeholder="Units suchen...">
                <span id="units-search-helper" class="sr-only">Suche nach Slug oder Titel.</span>
              </div>
              <div class="md3-filter-chips" role="group" aria-label="Filteroptionen">
                <button type="button" id="filter-inactive" class="md3-chip" aria-pressed="false">
                  <span class="material-symbols-rounded md3-chip__icon" aria-hidden="true">visibility_off</span>
                  <span class="md3-chip__label">Inaktive anzeigen</span>
                </button>
              </div>
            </div>
            <div class="md3-section-toolbar__end">
              <button id="refresh-units" class="md3-button md3-button--outlined" type="button">
                <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">refresh</span>
                Aktualisieren
              </button>
              <button id="save-units" class="md3-button md3-button--filled" type="button" disabled>
                <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">save</span>
                Änderungen speichern
              </button>
            </div>
          </div>
          <p id="units-actions-helper" class="md3-helper-text" role="status" aria-live="polite">
            Änderungen vornehmen, um Speichern zu aktivieren.
          </p>

          <!-- Units Save Result -->
          <div id="units-action-result" class="md3-action-result" role="status" aria-live="polite" hidden></div>

          <!-- Units Table -->
          <div class="md3-table-container">
            <table class="md3-table" id="units-table">
              <thead>
                <tr>
                  <th class="col-w-15">Slug</th>
                  <th class="col-w-25">Titel</th>
                  <th class="col-w-10">Fragen</th>
                  <th class="col-w-10 md3-table__cell--center">Aktiv</th>
                  <th class="col-w-10 md3-table__cell--center">Reihenfolge</th>
                  <th class="col-w-15 md3-hide-mobile">Release</th>
                  <th class="col-w-15 md3-table__cell--actions">Aktionen</th>
                </tr>
              </thead>
              <tbody id="units-body">
                <!-- Populated by JS -->
                <tr class="md3-table__loading">
                  <td colspan="7">
                    <span class="material-symbols-rounded md3-spinner">progress_activity</span>
                    Laden...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<!-- Confirmation Dialog -->
<dialog id="confirm-dialog" class="md3-dialog" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title">
  <div class="md3-dialog__container">
    <div class="md3-dialog__surface">
      <header class="md3-dialog__header">
        <h2 id="confirm-title" class="md3-title-large md3-dialog__title">Bestätigen</h2>
      </header>
      <div class="md3-dialog__content">
        <p id="confirm-message" class="md3-body-medium">Sind Sie sicher?</p>
      </div>
      <div class="md3-dialog__actions">
        <button type="button" class="md3-button md3-button--text" id="confirm-cancel">Abbrechen</button>
        <button type="button" class="md3-button md3-button--filled md3-button--danger" id="confirm-ok">Bestätigen</button>
      </div>
    </div>
  </div>
</dialog>

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/admin/quiz_content.js') }}" type="module"></script>
{% endblock %}
