{% extends 'base.html' %}
{% set page_name = 'quiz' %}
{% block page_title %}Quiz – Games.Hispanistica{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/games/quiz.css') }}">
  <script src="{{ url_for('static', filename='js/games/quiz-i18n.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/games/quiz-entry.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="game-shell" data-game="quiz" data-topic="{{ topic_id }}">
  <div class="md3-page quiz-page-stack" role="main" aria-label="Quiz Entry">
    
    <!-- Back link -->
    <div class="quiz-back-link">
      <a href="{{ url_for('quiz.quiz_index') }}" class="quiz-btn quiz-btn--ghost">
        <span class="material-symbols-rounded">arrow_back</span>
        <span data-i18n="ui.quiz.back_to_topics">Zurück zur Übersicht</span>
      </a>
    </div>

    <!-- EINHEITLICHER Container für alle Cards (stabile Breite) -->
    <main class="quiz-detail-container">
      
      <!-- 1) Info-Card: Titel + Beschreibung + Metadata -->
      <section class="quiz-info-card">
        <div class="quiz-info-card__header">
          <span class="quiz-info-card__icon material-symbols-rounded" aria-hidden="true">quiz</span>
          <div class="quiz-info-card__titles">
            <span class="quiz-info-card__eyebrow">Quiz</span>
            <h1 class="quiz-info-card__title" id="quiz-topic-title">{{ topic_title_key }}</h1>
          </div>
        </div>
        
        <!-- Description with Label -->
        <div class="quiz-info-card__section">
          <span class="quiz-info-card__label">Beschreibung</span>
          <p class="quiz-info-card__text" id="quiz-topic-description"></p>
        </div>
        
        <!-- Divider -->
        <div class="quiz-info-card__divider"></div>
        
        <!-- Based On / Grundlage -->
        <div class="quiz-info-card__based-on" id="quiz-topic-based-on"></div>
        
        <!-- Authors section (Quiz-Autor:innen) -->
        <div class="quiz-info-card__authors" id="quiz-topic-authors"></div>
      </section>
      
      <!-- 2) Start-Card: Authentifizierung + Start-Buttons -->
      <section class="quiz-start-card">
        <h2 class="quiz-start-card__title">Los geht's</h2>

        {% if player_authenticated %}
          <!-- AUTHENTICATED STATE -->
          <div class="quiz-start-card__status">
            {% if player_anonymous %}
              <span class="quiz-start-card__status-text">
                <span class="material-symbols-rounded">person_off</span>
                Du spielst anonym
              </span>
              <span class="quiz-start-card__status-hint">Dein Spiel erscheint nicht in der Rangliste</span>
            {% else %}
              <span class="quiz-start-card__status-text">
                <span class="material-symbols-rounded">person</span>
                Angemeldet als {{ player_name }}
              </span>
            {% endif %}
            <button type="button" class="quiz-start-card__action-btn" id="quiz-logout-btn">
              <span class="material-symbols-rounded">logout</span>
              <span>{% if player_anonymous %}Beenden{% else %}Abmelden{% endif %}</span>
            </button>
          </div>

          <div class="quiz-start-card__cta">
            <button type="button" class="quiz-start-card__btn-primary" id="quiz-start-btn">
              <span class="material-symbols-rounded">play_arrow</span>
              <span>Quiz starten</span>
            </button>
          </div>

        {% else %}
          <!-- NOT AUTHENTICATED STATE -->
          <div class="quiz-start-card__auth-section">
            <!-- Primary: Mit Namen spielen -->
            <div class="quiz-start-card__primary-option">
              <button type="button" class="quiz-start-card__btn-primary" id="quiz-show-login-btn">
                <span class="material-symbols-rounded">person</span>
                <span>Mit Namen spielen</span>
              </button>
              <p class="quiz-start-card__hint">Du wählst einen Spielernamen. Kein Klarname nötig.</p>
            </div>

            <!-- Login Dialog (initially hidden, 100% container width) -->
            <div class="quiz-login-dialog" id="quiz-login-container" hidden>
              <h3 class="quiz-login-dialog__title">Spielername und PIN</h3>
              
              <p class="quiz-login-dialog__hint">
                Gib deinen Namen und einen 4-stelligen PIN ein.
                Bei einem neuen Namen wird automatisch ein Profil erstellt.
              </p>
              
              <form class="quiz-login-dialog__form" id="quiz-auth-form">
                <div class="quiz-input-group">
                  <label class="quiz-input-group__label" for="quiz-name">Spielername</label>
                  <input 
                    type="text" 
                    id="quiz-name" 
                    name="name" 
                    class="quiz-input-group__input" 
                    placeholder="Dein Name"
                    maxlength="50"
                    autocomplete="username"
                    required
                  >
                </div>
                
                <div class="quiz-input-group">
                  <label class="quiz-input-group__label" for="quiz-pin">PIN</label>
                  <input 
                    type="text" 
                    id="quiz-pin" 
                    name="pin" 
                    class="quiz-input-group__input quiz-input-group__input--pin" 
                    placeholder="4 Zeichen (A-Z, 0-9)"
                    maxlength="4"
                    pattern="[A-Za-z0-9]{4}"
                    autocomplete="current-password"
                    required
                  >
                </div>
                
                <div class="quiz-input-group__error" id="quiz-auth-error" hidden></div>
                
                <button type="submit" class="quiz-start-card__btn-primary quiz-start-card__btn-primary--full" id="quiz-auth-submit">
                  <span class="material-symbols-rounded">play_arrow</span>
                  <span>Starten</span>
                </button>
              </form>
            </div>

            <!-- Divider between options -->
            <div class="quiz-start-card__divider">
              <span>oder</span>
            </div>

            <!-- Secondary: Anonym spielen -->
            <div class="quiz-start-card__secondary-option">
              <button type="button" class="quiz-start-card__btn-secondary" id="quiz-anonymous-btn">
                <span class="material-symbols-rounded">person_off</span>
                <span>Anonym spielen</span>
              </button>
              <p class="quiz-start-card__hint">Dein Spiel erscheint nicht in der Rangliste</p>
            </div>
          </div>
        {% endif %}
      </section>

      <!-- 3) Rangliste-Card (kein dunkler Header, klar getrennt) -->
      <section class="quiz-leaderboard-card">
        <h2 class="quiz-leaderboard-card__title">
          <span class="material-symbols-rounded">leaderboard</span>
          Rangliste
        </h2>
        <div id="quiz-leaderboard-content">
          <div class="quiz-loading">
            <span class="material-symbols-rounded quiz-loading__icon">hourglass_empty</span>
          </div>
        </div>
      </section>

    </main>
  </div>
</div>
{% endblock %}
