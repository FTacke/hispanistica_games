{% extends 'base.html' %}
{% set page_name = 'quiz' %}
{% set page_section = 'Quiz' %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/games/quiz.css') }}">
  <script src="{{ url_for('static', filename='js/games/quiz-i18n.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/games/quiz-play.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="game-shell" data-game="quiz" data-topic="{{ topic_id }}">
  <!-- Accessibility: Live region for answer feedback -->
  <div class="quiz-sr-only" aria-live="polite" aria-atomic="true" id="quiz-a11y-announce"></div>
  
  <div class="md3-page quiz-play-page quiz-page-stack" role="main" aria-label="Quiz Gameplay">
    
    <!-- HUD/SPIEL-BAR: Flat full-width Instrumentenleiste -->
    <header class="quiz-hud" id="quiz-hud">
      <!-- Links: Quiz-Titel -->
      <div class="quiz-hud__title">
        <span class="material-symbols-rounded" aria-hidden="true">quiz</span>
        <h1 id="quiz-play-title">{{ topic_title_key }}</h1>
      </div>
      
      <!-- Rechts: Spielerstatus + Spiel beenden -->
      <div class="quiz-hud__actions">
        <!-- Spielerstatus-Chip: nur Icon + Name -->
        {% if player_name %}
          <span class="quiz-hud__status-chip">
            <span class="material-symbols-rounded">person</span>
            <span>{{ player_name }}</span>
          </span>
        {% else %}
          <span class="quiz-hud__status-chip quiz-hud__status-chip--anon">
            <span class="material-symbols-rounded">person_off</span>
            <span>Anonym</span>
          </span>
        {% endif %}
        
        <!-- Spiel beenden Button -->
        <a href="{{ url_for('quiz.quiz_topic_entry', topic_id=topic_id) }}" class="quiz-hud__exit-btn" id="quiz-exit-btn" aria-label="Beenden" title="Beenden">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
          <span class="quiz-hud__exit-label">Beenden</span>
        </a>
      </div>
    </header>

    <!-- Quiz Content Container (stabile Breite) -->
    <div class="quiz-play-container">

    <!-- Question Container with transition wrapper -->
    <main class="quiz-question-container" id="quiz-question-container">
      <div class="quiz-question-wrapper" id="quiz-question-wrapper" data-transition-state="idle">
        <div class="quiz-question" id="quiz-question">
          <!-- Card Header: Level links + Fortschritt rechts (eine Zeile) -->
          <div class="quiz-question-card__meta">
            <div class="quiz-level-chip" id="quiz-level-chip">
              <span class="material-symbols-rounded">signal_cellular_alt</span>
              <span data-i18n="ui.quiz.level_label">Level</span>
              <span id="quiz-level-num">1</span>
            </div>
            <div class="quiz-stat-chip quiz-stat-chip--progress quiz-question-progress" id="quiz-progress">
              <span class="quiz-progress-label" data-i18n="ui.quiz.question_label">Frage</span>
              <span id="quiz-question-current">1</span>
              <span class="quiz-progress-sep">/</span>
              <span id="quiz-question-total">10</span>
              <span class="quiz-progress-compact" id="quiz-question-compact" aria-hidden="true">1/10</span>
            </div>
            <div class="quiz-question-meta-stats" aria-label="Joker und Timer">
              <!-- Joker -->
              <button type="button" class="quiz-stat-chip quiz-stat-chip--joker" id="quiz-joker-btn">
                <span class="material-symbols-rounded">casino</span>
                <span>50:50</span>
                <span class="quiz-joker__count" id="quiz-joker-count">2</span>
              </button>

              <!-- Timer - stärker durch filled style -->
              <div class="quiz-stat-chip quiz-stat-chip--timer" id="quiz-timer">
                <span class="material-symbols-rounded">timer</span>
                <span id="quiz-timer-display">30</span>
              </div>
            </div>
          </div>
          
          <!-- Visual Divider: subtle separation between meta and question -->
          <div class="quiz-question-divider"></div>
          
          <!-- Question Prompt Surface: Dedicated section for the question text + media -->
          <section class="quiz-question-prompt-surface">
            <div class="quiz-question-media-surface" id="quiz-question-media-surface">
              <p class="quiz-question__prompt" id="quiz-question-prompt" tabindex="-1">
                <!-- Question text loaded dynamically -->
              </p>
              
              <div class="quiz-question__media" id="quiz-question-media" hidden>
                <!-- Audio player if present -->
              </div>
            </div>
          </section>
          
          <!-- Answers Section: separate from question prompt -->
          <div class="quiz-answers" id="quiz-answers" role="group" aria-label="Antwortoptionen">
            <!-- Answers loaded dynamically -->
          </div>
        </div>
        
        <!-- Explanation Card (separate from feedback, always visible after answer) -->
        <div class="quiz-explanation-card" id="quiz-explanation-card" hidden>
          <!-- Header: Status & Title (saubere typografische Trennung) -->
          <div class="quiz-explanation-card__header">
            <!-- Status line (correct/wrong header) -->
            <p class="quiz-explanation-card__status" id="quiz-explanation-status" role="status" aria-live="polite"></p>
            
            <!-- Title: Icon + Label -->
            <h3 class="quiz-explanation-card__title">
              <span class="material-symbols-rounded">lightbulb</span>
              <span id="quiz-explanation-title-label" data-i18n="ui.quiz.explanation">Erklärung</span>
            </h3>
          </div>
          
          <!-- Body text -->
          <p class="quiz-explanation-card__body" id="quiz-explanation-text"></p>
        </div>
        
        <!-- Weiter Button (visible after answer selection) -->
        <button type="button" class="quiz-btn quiz-btn--primary quiz-btn--full quiz-weiter-btn" id="quiz-weiter-btn" hidden>
          <span class="material-symbols-rounded">arrow_forward</span>
          <span data-i18n="ui.quiz.weiter">Weiter</span>
        </button>
      </div>
    </main>

    <!-- Level Up Screen: Dynamically rendered by renderLevelUpInContainer() -->

    <!-- Final Screen (Hidden by default) -->
    <section class="quiz-final-container" id="quiz-final-container" hidden aria-hidden="true">
        <div class="quiz-final-card">
            <div class="quiz-final-header">
                <h2 class="quiz-final-title" data-i18n="ui.quiz.finished">Quiz beendet!</h2>
                <div class="quiz-final-score-display">
                    <span class="quiz-final-score-value" id="quiz-final-score">0</span>
                    <span class="quiz-final-score-label" data-i18n="ui.quiz.points">Punkte</span>
                </div>
            </div>
            
            <div class="quiz-final-breakdown" id="quiz-final-breakdown">
                <!-- Breakdown items injected here -->
            </div>

            <div class="quiz-final-actions">
                <a href="{{ url_for('quiz.quiz_index') }}" class="quiz-btn quiz-btn--outlined">
                    <span class="material-symbols-rounded">list</span>
                    <span data-i18n="ui.quiz.topics">Themen</span>
                </a>
                <button type="button" class="quiz-btn quiz-btn--primary" id="quiz-restart-btn">
                    <span class="material-symbols-rounded">replay</span>
                    <span data-i18n="ui.quiz.play_again">Nochmal spielen</span>
                </button>
            </div>
        </div>
    </section>
    </div><!-- .quiz-play-container -->

  </div>
</div>
{% endblock %}
