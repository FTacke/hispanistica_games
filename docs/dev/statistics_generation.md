---
title: "Statistics Generation Documentation"
status: active
owner: backend-team
updated: "2025-11-21"
tags: [statistics, blacklab, api, aggregation]
links:
  - ../reference/advanced-search-api.md
---

# Statistics Generation in Advanced Search

This document describes how statistics are generated from search results in the Advanced Search module, including the parallel execution strategy and BlackLab integration.

---

## Overview

Statistics are generated by the `/search/advanced/api/stats` endpoint (mapped to `stats_data` in `src/app/search/advanced_api.py`). Unlike the main search results which use pagination, the statistics endpoint aggregates data across the **entire result set**.

### Architecture

```mermaid
graph TD
    A[Frontend (initStatsTabAdvanced.js)] -->|GET /stats| B[Flask Backend (stats_data)]
    B -->|ThreadPoolExecutor| C{Parallel Requests}
    C -->|group=hit:country| D[BlackLab Server]
    C -->|group=hit:speaker_type| D
    C -->|group=hit:sex| D
    C -->|...| D
    D -->|JSON hitGroups| B
    B -->|JSON Aggregated| A
    A -->|ECharts| E[Charts]
```

---

## 1. Query Construction

The statistics endpoint receives the same parameters as the search endpoint.
- **CQL Pattern**: Reconstructed from `q` and `mode`.
- **Filters**: Applied as `filter` (doc-level) or injected into CQL (token-level).

The backend ensures that the set of hits used for statistics is identical to the set of hits shown in the table.

---

## 2. Parallel Aggregation Strategy

To provide responsive charts, the backend executes multiple BlackLab requests in parallel, one for each dimension.

### Dimensions
The system groups hits by the following token-level annotations:
- `country` (`hit:country_code`)
- `speaker_type` (`hit:speaker_type`)
- `sex` (`hit:speaker_sex`)
- `mode` (`hit:speaker_mode`)
- `discourse` (`hit:speaker_discourse`)
- `radio` (`hit:radio`)
- `city` (`hit:city`)
- `file_id` (`hit:file_id`)

### Implementation Details
- **Executor**: `concurrent.futures.ThreadPoolExecutor` (max 8 workers).
- **BlackLab Parameter**: `group=hit:<field_name>`
- **Limit**: `number=1000` (Max groups returned, not max hits).
- **Wait**: `waitfortotal=true` (Ensures accurate counts).

### Code Reference
```python
# src/app/search/advanced_api.py

def bls_group_by_field(field_name, patt, filter_cql, base_params):
    params["group"] = f"hit:{field_name}"
    # ...
    response = _make_bls_request(..., params)
    return response.json().get("hitGroups", [])
```

---

## 3. Response Format

The API returns a JSON object where keys are dimensions and values are lists of groups.

```json
{
  "total_hits": 1500,
  "by_country": [
    {"key": "ES", "n": 1000},
    {"key": "MX", "n": 500}
  ],
  "by_speaker_type": [
    {"key": "native", "n": 1200},
    {"key": "non-native", "n": 300}
  ]
  // ... other dimensions
}
```

---

## 4. Frontend Integration

The frontend (`static/js/modules/stats/initStatsTabAdvanced.js`) fetches this data and renders it using ECharts.

- **Trigger**: The stats fetch is triggered independently of the table load to avoid blocking the UI.
- **Mapping**: Some values (like `lemma`) might be mapped or formatted before display.
- **Interactivity**: Clicking a bar in a chart adds that value as a filter to the search form.

