/**
 * Advanced Search MD3 Components
 * 
 * MD3-konformes Layout für Advanced Search.
 * Keine Inline-Styles. Alle Styles nutzen CSS-Variablen aus tokens.css.
 * 
 * Struktur:
 * - .md3-advanced: Container
 * - .md3-advanced__form: Formular
 * - .md3-advanced__row: Zeilen für Query/Filter
 * - .md3-advanced__summary: Results Summary
 * - .md3-advanced__toolbar: Export-Buttons
 * - .md3-advanced__tablewrap: DataTables Container
 */

/* ========================================
   CONTAINER
   ======================================== */

.md3-advanced {
  padding-block: var(--space-4, 1rem);
  max-width: 1400px;
  margin-inline: auto;
}

/* ========================================
   FORM LAYOUT
   ======================================== */

.md3-advanced__form {
  display: flex;
  flex-direction: column;
  gap: var(--space-6, 1.5rem);
  margin-block-end: var(--space-6, 1.5rem);
  padding: var(--space-6, 1.5rem);
  background: var(--md-sys-color-surface-container);
  border: 1px solid var(--md-sys-color-outline-variant);
  border-radius: var(--radius-sm, 8px);
}

/* Row: Query + Mode + Expert */
.md3-advanced__row {
  display: grid !important;
  gap: var(--space-3, 0.75rem);
  align-items: end;
  margin-bottom: var(--space-6, 1.5rem);
}

.md3-advanced__row:last-of-type {
  margin-bottom: 0;
}

.md3-advanced__row--query {
  grid-template-columns: 1fr 220px max-content !important;
}

/* Row: CQL Raw (hidden by default) */
.md3-advanced__row--cql {
  margin-block: var(--space-2, 0.5rem) 0;
}

.md3-advanced__row--cql[hidden] {
  display: none;
}

/* Simple divider used in templates */
.md3-divider {
  border: 0;
  border-top: 1px solid var(--md-sys-color-outline-variant, rgba(0,0,0,0.08));
  margin: var(--space-4, 1rem) 0;
}

/* When Token tab is active we must forcibly hide search-related panels to avoid accidental visibility
   Use high specificity and !important to override other inline styles or DataTables wrapper display values */
body.token-active #search-sub-tabs,
body.token-active #panel-resultados,
body.token-active #panel-estadisticas,
body.token-active #datatable-container,
body.token-active #adv-summary {
  display: none !important;
  visibility: hidden !important;
  height: 0 !important;
  overflow: hidden !important;
}

/* Add a subtle border-top to every search-card section for clearer separation
   except the first section in the card */
.md3-search-card__section + .md3-search-card__section {
  border-top: 1px solid var(--md-sys-color-outline-variant, rgba(0,0,0,0.06));
  padding-top: var(--space-4, 1rem);
}

/* Row: Filters (5 columns on desktop) */
.md3-advanced__row--filters {
  grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
  gap: var(--space-3, 0.75rem);
}

/* Filter Grid (alternative structure - if used with div instead of row) */
/* Matches .md3-corpus-filter-grid from forms.css but with desktop-first approach */
.md3-corpus-filter-grid {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: var(--space-3, 0.75rem);
  align-items: start;
  margin-bottom: var(--space-6, 1.5rem);
}

/* Responsive: Tablet (2-3 columns) */
@media (max-width: 1120px) {
  .md3-corpus-filter-grid {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}

/* Responsive: Small tablet/mobile landscape (2 columns) */
@media (max-width: 960px) {
  .md3-corpus-filter-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* Responsive: Mobile (1 column) */
@media (max-width: 600px) {
  .md3-corpus-filter-grid {
    grid-template-columns: 1fr;
  }
}

/* Responsive: Stack filters on mobile/tablet */
@media (max-width: 1120px) {
  .md3-advanced__form {
    padding: var(--space-4, 1rem);
    gap: var(--space-4, 1rem);
  }
}

@media (max-width: 960px) {
  .md3-advanced__row--query {
    grid-template-columns: 1fr !important;
  }

  .md3-advanced__row--filters {
    grid-template-columns: 1fr 1fr !important;
  }
}

@media (max-width: 600px) {
  .md3-advanced__row--filters {
    grid-template-columns: 1fr !important;
  }

  .md3-advanced__form {
    padding: var(--space-3, 0.75rem);
    gap: var(--space-3, 0.75rem);
  }
}

/* ========================================
   EXPERT TOGGLE (Switch-Style)
   ======================================== */

.md3-advanced__expert {
  display: flex;
  align-items: center;
  gap: var(--space-2, 0.5rem);
  cursor: pointer;
  user-select: none;
  padding: var(--space-2, 0.5rem);
  white-space: nowrap;
}

.md3-advanced__expert input[type="checkbox"] {
  /* Visually hidden but accessible */
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.md3-advanced__expert::before {
  content: '';
  display: block;
  width: 52px;
  height: 32px;
  background-color: var(--md-sys-color-surface-variant, #f3edf7);
  border: 2px solid var(--md-sys-color-outline, #79747e);
  border-radius: 16px;
  position: relative;
  transition: all 0.2s ease;
}

.md3-advanced__expert input:checked + span::before {
  background-color: var(--md-sys-color-primary, #0a5981);
  border-color: var(--md-sys-color-primary, #0a5981);
}

.md3-advanced__expert::after {
  content: '';
  position: absolute;
  left: var(--space-2, 0.5rem);
  width: 20px;
  height: 20px;
  background-color: var(--md-sys-color-outline, #79747e);
  border-radius: 50%;
  transition: all 0.2s ease;
}

.md3-advanced__expert input:checked ~ span::after {
  left: 34px;
  background-color: var(--md-sys-color-on-primary, #ffffff);
}

.md3-advanced__expert span {
  font-size: var(--md-sys-typescale-body-medium-font-size);
  font-family: var(--md-sys-typescale-base-font-family);
  color: var(--md-sys-color-on-surface);
}

/* ========================================
   SUMMARY BOX
   ======================================== */

.md3-advanced__summary {
  margin-block: var(--space-4);
  padding: var(--space-3) var(--space-4);
  background-color: var(--md-sys-color-surface-container-low);
  border-left: 4px solid var(--md-sys-color-primary);
  border-radius: var(--radius-sm);
  color: var(--md-sys-color-on-surface-variant);
  font-size: var(--md-sys-typescale-body-large-font-size);
  font-family: var(--md-sys-typescale-base-font-family);
}

.md3-advanced__summary[hidden] {
  display: none;
}

.md3-advanced__summary:focus {
  outline: 2px solid var(--md-sys-color-primary, #0a5981);
  outline-offset: 2px;
}

.md3-advanced__summary-query {
  font-weight: 600;
  color: var(--md-sys-color-on-surface, #1c1b1f);
}

.md3-advanced__summary-count {
  font-weight: 700;
  color: var(--md-sys-color-primary, #0a5981);
}

.md3-advanced__summary-total {
  color: var(--md-sys-color-on-surface-variant, #4a4f55);
}

/* Make stats summary match results summary layout: full width, left aligned */
.md3-advanced__summary.md3-stats-summary {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: var(--space-3, 0.75rem);
  width: 100%;
}

/* ========================================
   CQL BUILDER LAYOUT
   ======================================== */

.cql-token-row {
  display: block;
  /* Use surface-container-lowest for clean white background */
  border: 1px solid var(--md-sys-color-outline-variant);
  border-radius: var(--radius-sm, 8px);
  padding: var(--space-4, 1rem);
  margin-bottom: var(--space-4, 1rem);
  position: relative;
  /* subtle elevation */
  box-shadow: 0 6px 18px rgba(16,24,40,0.06), 0 2px 6px rgba(16,24,40,0.04);
}

/* Token tab content should follow the same max-width/layout as the advanced search
   so forms and datatables don't expand beyond the site's main content width */
#tab-token .md3-search-card,
#tab-token .md3-corpus-table-container,
#tab-token #token-results {
  max-width: 1400px;
  margin-inline: auto;
}

.cql-token-row h4 {
  font-size: var(--md-sys-typescale-title-small-font-size);
  margin: 0 0 var(--space-2, 0.5rem) 0;
}

/* Ensure header spacing inside token row to avoid overlapping the input row */
.cql-token-row .d-flex.align-items-center {
  margin-bottom: var(--space-4, 1rem); /* increased spacing to avoid overlap */
}

.cql-token-row .md3-outlined-textfield {
  width: 100%;
}

.cql-token-row .row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--space-3, 0.75rem);
  margin-top: var(--space-6);
}

.cql-distance-row {
  display: flex;
  align-items: center;
  gap: var(--space-3, 0.75rem);
  padding: 0.25rem 0.5rem;
}

.cql-token-row .delete-token-btn {
  position: absolute;
  top: 6px;
  right: 8px;
  border-radius: 999px;
  padding: 6px;
  background: transparent;
}

.cql-token-row .delete-token-btn:hover {
  background: rgba(0,0,0,0.04);
}

/* Textfield labels inside token rows need matching background for the notch cutout */
.cql-token-row .md3-outlined-textfield .md3-outlined-textfield__label {
  background: var(--md-sys-color-surface-container-lowest, #ffffff);
}

/* Compact numeric fields */
.md3-outlined-textfield--compact {
  width: auto;
}

@media (max-width: 720px) {
  .cql-token-row .row {
    grid-template-columns: 1fr;
  }
}

/* ========================================
   BADGE: Server-Filter aktiv
   ======================================== */

.md3-badge--serverfilter {
  display: inline-flex;
  align-items: center;
  gap: var(--space-1);
  padding: var(--space-1) var(--space-2);
  margin-inline-start: var(--space-2);
  border-radius: 999px;
  background-color: var(--md-sys-color-secondary-container);
  color: var(--md-sys-color-on-secondary-container);
  font-size: var(--md-sys-typescale-label-small-font-size);
  font-family: var(--md-sys-typescale-base-font-family);
  font-weight: 500;
  white-space: nowrap;
}

.md3-badge--serverfilter[hidden] {
  display: none;
}

.md3-badge--serverfilter .material-symbols-rounded {
  font-size: 1rem;
}

/* ========================================
   TOOLBAR (Export Buttons)
   ======================================== */

.md3-advanced__toolbar {
  display: flex;
  align-items: center;
  gap: var(--space-2, 0.5rem);
  margin-block-end: var(--space-3, 0.75rem);
  padding-block: var(--space-2, 0.5rem);
}

.md3-advanced__toolbar-spacer {
  flex: 1;
}

.md3-advanced__exports {
  display: flex;
  gap: var(--space-2, 0.5rem);
}

/* Export buttons inherit from global .md3-button-tonal/.md3-button-outlined */

/* ========================================
   TABLE WRAPPER
   ======================================== */

.md3-advanced__tablewrap {
  overflow-x: auto;
  overflow-y: visible;
  border-radius: var(--radius-md, 12px);
  border: 1px solid var(--md-sys-color-outline-variant, #cac4d0);
  background-color: var(--md-sys-color-surface, #ffffff);
}

/* Table: Use existing .md3-corpus-table or .md3-datatable */
.md3-advanced__tablewrap .md3-corpus-table,
.md3-advanced__tablewrap .md3-datatable {
  width: 100%;
  border-collapse: collapse;
}

/* ========================================
   RESPONSIVE: Mobile optimizations
   ======================================== */

@media (max-width: 600px) {
  .md3-advanced {
    padding-inline: var(--space-2, 0.5rem);
  }

  .md3-advanced__toolbar {
    flex-direction: column;
    align-items: stretch;
  }

  .md3-advanced__exports {
    flex-direction: column;
  }

  .md3-advanced__exports .md3-button-tonal,
  .md3-advanced__exports .md3-button-outlined {
    width: 100%;
  }
}

/* ========================================
   ACCESSIBILITY
   ======================================== */

/* Screen-reader only class */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* Focus visible improvements */
.md3-advanced__form input:focus-visible,
.md3-advanced__form select:focus-visible {
  outline: 2px solid var(--md-sys-color-primary, #0a5981);
  outline-offset: 2px;
}

/* ========================================
   FILTER CHECKBOXES (include_regional, sensitive)
   ======================================== */

.md3-advanced__checkboxes {
  display: flex;
  flex-direction: column;
  gap: var(--space-2, 0.5rem);
  padding-block: var(--space-2, 0.5rem);
}

.md3-advanced__checkbox-label {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  cursor: pointer;
  font-size: var(--md-sys-typescale-body-medium-font-size);
  font-family: var(--md-sys-typescale-base-font-family);
  color: var(--md-sys-color-on-surface);
}

.md3-advanced__checkbox-label input[type='checkbox'] {
  width: 20px;
  height: 20px;
  accent-color: var(--md-sys-color-primary, #0a5981);
  cursor: pointer;
}

/* ========================================
   FORM ACTIONS (Submit + Reset Buttons)
   ======================================== */

.md3-form-actions {
  display: flex !important;
  gap: var(--space-3, 0.75rem);
  margin-block-start: var(--space-4, 1rem);
  flex-wrap: wrap;
}

/* ========================================
   DIALOG SYSTEM (Overlay & Base)
   ======================================== */

/* Dialog Overlay */
.md3-dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  display: none; /* hidden by default, enabled when active */
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
}

.md3-dialog-overlay.active {
  display: flex;
  opacity: 1;
  pointer-events: auto;
}

/* Dialog Base */
.md3-dialog--advanced {
  background: var(--md-sys-color-surface);
  border-radius: var(--radius-lg);
  box-shadow: var(--elev-3);
  min-width: 280px;
  max-width: 560px;
  display: flex;
  flex-direction: column;
  transform: scale(0.9);
  transition: transform 0.2s ease;
}

.md3-dialog-overlay.active .md3-dialog--advanced {
  transform: scale(1);
}

/* Dialog Container (Inner Wrapper) */
.md3-dialog__container {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  padding: var(--space-4);
  max-width: 90vw;
  max-height: 90vh;
  overflow: hidden;
}

/* Dialog header layout: ensure icon + title are aligned */
.md3-dialog__header {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  margin-bottom: var(--space-4);
}

/* Dialog large variant tweaks */
.md3-dialog--large {
  max-width: 900px;
  width: min(900px, 95vw);
}

/* Expert header layout: ensure title and help icon align and help icon floats to right */
.md3-expert-header {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  width: 100%;
  justify-content: space-between; /* title left, help icon right */
}

/* For code block in dialogs: cap height and allow vertical scroll */
.md3-dialog__content .md3-code-block pre {
  max-height: 56vh;
  overflow-y: auto;
  margin: 0;
  padding: var(--space-4);
  background: var(--md-sys-color-surface-container-low);
  border: 1px solid var(--md-sys-color-outline-variant);
  border-radius: var(--radius-md);
}

/* Prompt container styling - tight spacing for dialogs */
.md3-prompt-container {
  margin: var(--space-2) 0 0 0;
}

.md3-prompt-title {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--md-sys-color-on-surface);
  margin: 0 0 var(--space-1) 0;
}

.md3-prompt-subtitle {
  font-size: 0.8125rem;
  color: var(--md-sys-color-on-surface-variant);
  margin: 0 0 var(--space-2) 0;
}

/* Dialog Title */
.md3-dialog__title {
  margin: 0;
  padding: var(--space-2) var(--space-4) var(--space-1);
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--md-sys-color-on-surface);
  letter-spacing: 0.15px;
}

/* Dialog header — generic for all md3 dialogs */
.md3-dialog__header {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  margin-bottom: var(--space-2);
}

.md3-dialog--error .md3-dialog__title {
  color: var(--md-sys-color-error);
}

/* Dialog Content */
.md3-dialog__content {
  padding: 0 0 var(--space-3) 0;
  font-size: 0.875rem;
  line-height: 1.5;
  color: var(--md-sys-color-on-surface-variant);
  flex-grow: 1;
  overflow-y: auto;
}

/* Dialog Actions */
.md3-dialog__actions {
  padding: var(--space-3) 0 0 0;
  display: flex;
  justify-content: flex-end;
  gap: var(--space-3);
  border-top: 1px solid var(--md-sys-color-outline-variant);
  margin-top: auto;
  flex-shrink: 0;
}
