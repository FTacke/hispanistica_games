# =============================================================================
# CO.RA.PAN Production Deployment Workflow
# =============================================================================
#
# This workflow automatically deploys the application to the production server
# (marele.online.uni-marburg.de) when code is pushed to the main branch.
#
# The deployment runs on a self-hosted GitHub Actions runner installed on the
# production server itself. The runner executes the deploy_prod.sh script which:
#   - Updates the code from Git
#   - Builds a new Docker image
#   - Restarts the container with new image
#   - Runs database migrations
#
# Prerequisites on the server:
#   - GitHub self-hosted runner configured and running
#   - Docker installed
#   - /srv/webapps/games_hispanistica/{app,data,media,config,logs} directories set up
#   - passwords.env configured in /srv/webapps/games_hispanistica/config/
#   - data/media synced via rsync (not part of this workflow)
#
# =============================================================================

name: Deploy to Production

on:
  push:
    branches:
      - main

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to marele.online.uni-marburg.de
    runs-on: self-hosted

    steps:
      - name: Deploy games_hispanistica
        run: |
          cd /srv/webapps/games_hispanistica/app
          bash scripts/deploy_prod.sh

      - name: Verify deployment
        run: |
          # Wait a moment for the container to fully start
          sleep 10
          # Check if container is running
          if docker ps --format '{{.Names}}' | grep -q '^games-hispanistica$'; then
            echo "✓ Container games-hispanistica is running"
            docker ps --filter "name=games-hispanistica" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          else
            echo "✗ Container games-hispanistica is not running!"
            docker logs games-hispanistica 2>&1 | tail -50
            exit 1
          fi
