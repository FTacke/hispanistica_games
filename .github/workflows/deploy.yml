name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy games_hispanistica
    runs-on: [self-hosted, games-prod]

    steps:
      - name: Debug - Check environment
        run: |
          echo "=== Environment Debug ==="
          whoami
          pwd
          ls -la /srv/webapps/games_hispanistica/app || echo "app dir not accessible"
          docker network ls | grep -E 'NAME|corapan' || echo "corapan-network not found"
          
      - name: Sync server checkout to origin/main
        run: |
          cd /srv/webapps/games_hispanistica/app
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          
      - name: Deploy via deploy_prod.sh
        run: |
          cd /srv/webapps/games_hispanistica/app
          bash scripts/deploy/deploy_prod.sh

      - name: Final verification
        run: |
          sleep 5
          if docker ps --format '{{.Names}}' | grep -q '^games-webapp$'; then
            echo "✓ Container games-webapp is running"
            docker ps --filter "name=games-webapp" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          else
            echo "✗ Container games-webapp is not running!"
            docker logs games-webapp 2>&1 | tail -50
            exit 1
          fi

          HEALTH=$(curl -sf http://localhost:7000/health || echo "FAILED")
          if echo "$HEALTH" | grep -q '"status"'; then
            echo "✓ Health check passed: $HEALTH"
          else
            echo "✗ Health check failed"
            exit 1
          fi
