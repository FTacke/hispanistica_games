# =============================================================================
# games_hispanistica Production Deployment Workflow
# =============================================================================
#
# Automatically deploys the application to production when code is pushed
# to the main branch. Uses a self-hosted GitHub Actions runner on the
# production server.
#
# The deployment executes scripts/deploy/deploy_prod.sh which:
#   - Updates code from Git
#   - Builds Docker image (tagged with git SHA)
#   - Restarts container with new image
#   - Runs database setup (idempotent)
#   - Executes smoke checks
#
# Prerequisites on server (run server_bootstrap.sh first):
#   - GitHub self-hosted runner configured and running
#   - Docker installed
#   - /srv/webapps/games_hispanistica/{app,data,media,config,logs} exist
#   - passwords.env configured in config/
#   - Docker network 'games-network' exists
#
# See: docs/components/deployment/README.md
# =============================================================================

name: Deploy to Production

on:
  push:
    branches:
      - main

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy games_hispanistica
    runs-on: self-hosted

    steps:
      - name: Deploy via deploy_prod.sh
        run: |
          cd /srv/webapps/games_hispanistica/app
          bash scripts/deploy/deploy_prod.sh

      - name: Final verification
        run: |
          # Additional verification after deployment
          sleep 5

          # Check container is running
          if docker ps --format '{{.Names}}' | grep -q '^games-webapp$'; then
            echo "✓ Container games-webapp is running"
            docker ps --filter "name=games-webapp" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          else
            echo "✗ Container games-webapp is not running!"
            docker logs games-webapp 2>&1 | tail -50
            exit 1
          fi

          # Verify health endpoint
          HEALTH=$(curl -sf http://localhost:7000/health || echo "FAILED")
          if echo "$HEALTH" | grep -q '"status"'; then
            echo "✓ Health check passed: $HEALTH"
          else
            echo "✗ Health check failed"
            exit 1
          fi
